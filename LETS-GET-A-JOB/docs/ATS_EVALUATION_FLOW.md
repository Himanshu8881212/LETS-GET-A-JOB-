# ATS Evaluation Flow Documentation

## Overview

The AI ATS Evaluator feature processes job descriptions, resumes, and cover letters through n8n workflows, stores the data in a SQLite database, and provides detailed evaluation results.

## Architecture

### Database Schema

**Table: `ats_evaluations`**

```sql
CREATE TABLE ats_evaluations (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  
  -- Source data
  job_url TEXT,
  job_description_text TEXT NOT NULL,
  resume_text TEXT NOT NULL,
  cover_letter_text TEXT NOT NULL,
  
  -- Evaluation results (stored as JSON)
  evaluation_result TEXT,
  overall_score REAL,
  
  -- Metadata
  resume_version_id INTEGER,
  cover_letter_version_id INTEGER,
  job_application_id INTEGER,
  
  -- Timestamps
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- Foreign keys
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (resume_version_id) REFERENCES resume_versions(id) ON DELETE SET NULL,
  FOREIGN KEY (cover_letter_version_id) REFERENCES cover_letter_versions(id) ON DELETE SET NULL,
  FOREIGN KEY (job_application_id) REFERENCES job_applications(id) ON DELETE SET NULL
);
```

## Workflow Steps

### Step 1: Process Job Description
- **Endpoint**: `POST /api/n8n/process-jd`
- **Input**: `{ jobUrl: string }`
- **n8n Workflow**: Job Desc (W4eOFap2LMUil7S0)
- **Output**: Summarized job description text

### Step 2: Process Resume
- **Endpoint**: `POST /api/n8n/process-resume`
- **Input**: FormData with PDF file
- **n8n Workflow**: Resume (tN7Ek0H0K9uw6qnZ)
- **Process**: 
  1. Convert PDF to base64 in Next.js API route
  2. Send to n8n webhook as JSON
  3. n8n converts base64 back to binary
  4. Extract text from PDF
  5. AI Agent cleans and structures the text
- **Output**: Parsed and cleaned resume text

### Step 3: Process Cover Letter
- **Endpoint**: `POST /api/n8n/process-cover-letter`
- **Input**: FormData with PDF file
- **n8n Workflow**: Cover Letter (zwYcZ0LBzWVP2Hxl)
- **Process**: Same as resume processing
- **Output**: Parsed and cleaned cover letter text

### Step 4: Save to Database
- **Endpoint**: `POST /api/ats-evaluations`
- **Input**:
  ```json
  {
    "job_url": "string",
    "job_description_text": "string",
    "resume_text": "string",
    "cover_letter_text": "string",
    "resume_version_id": "number | null",
    "cover_letter_version_id": "number | null"
  }
  ```
- **Output**: `{ evaluation_id: number }`
- **Purpose**: Store processed data in database before evaluation

### Step 5: Run AI Evaluation
- **Endpoint**: `POST /api/n8n/evaluate-ats`
- **Input**:
  ```json
  {
    "job_description": "string",
    "resume_text": "string",
    "cover_letter_text": "string"
  }
  ```
- **n8n Workflow**: Eval (gAZ7Pz0kKA5UBuEW)
- **Output**: Detailed evaluation results with scores

### Step 6: Update Database with Results
- **Endpoint**: `PATCH /api/ats-evaluations`
- **Input**:
  ```json
  {
    "evaluation_id": "number",
    "evaluation_result": "object",
    "overall_score": "number"
  }
  ```
- **Purpose**: Store evaluation results in database

## API Routes

### POST /api/ats-evaluations
Save processed data to database before evaluation.

### PATCH /api/ats-evaluations
Update evaluation record with AI evaluation results.

### GET /api/ats-evaluations
List all evaluations for the current user.

### GET /api/ats-evaluations/:id
Get a specific evaluation by ID.

## n8n Workflow Configuration

### Common Configuration for All Workflows

**Webhook Node:**
- `httpMethod`: "POST"
- `responseMode`: "responseNode"
- Must have a `webhookId` (generated by n8n)

**AI Agent Node:**
- `promptType`: "define" (NOT "auto")
- `text`: Expression to extract input data
- `options.systemMessage`: Custom system prompt

**Respond to Webhook Node:**
- `respondWith`: "json"
- `responseBody`: Expression to format response

### Job Desc Workflow
- Uses Tavily MCP for web scraping
- Extracts and summarizes job description from URL

### Resume & Cover Letter Workflows
- **Code Node**: Converts base64 to binary
  ```javascript
  const base64Data = $input.item.json.body.pdfBase64;
  const fileName = $input.item.json.body.fileName || 'file.pdf';
  const binaryData = Buffer.from(base64Data, 'base64');
  return {
    json: {},
    binary: {
      data: {
        data: binaryData.toString('base64'),
        mimeType: 'application/pdf',
        fileName: fileName,
        fileExtension: 'pdf'
      }
    }
  };
  ```

- **Extract from File Node**:
  - `operation`: "pdf"
  - `options.joinPages`: true
  - Outputs: `{ text: string }` (single string, not array)

- **AI Agent Node**:
  - `text`: `"={{ $json.text }}"` (NOT `.join()` since joinPages makes it a string)

### Eval Workflow
- Uses Groq Chat Model (openai/gpt-oss-120b)
- Structured Output Parser for JSON schema validation
- Evaluates on 5 metrics:
  1. Role Fit & Requirements Match (30%)
  2. Skills & Keywords Coverage (25%)
  3. Impact & Evidence Quality (20%)
  4. ATS Compliance & Clarity (15%)
  5. Cover Letter Effectiveness (10%)

## Testing

### Test All Workflows
```bash
./scripts/test-all.sh
```

### Test Database Flow
```bash
./scripts/test-database-flow.sh
```

## Common Issues & Solutions

### Issue: "No prompt specified" error
**Solution**: Set `promptType: "define"` in AI Agent node

### Issue: "Expected to find the prompt in an input field called 'chatInput'"
**Solution**: Change AI Agent `promptType` from "auto" to "define"

### Issue: Extract from File outputs weird field names
**Solution**: Set `operation: "pdf"` and `options.joinPages: true`

### Issue: `.join() is not a function` error
**Solution**: When `joinPages: true`, the text is already a string. Use `$json.text` instead of `$json.text.join()`

### Issue: Webhook returns 404
**Solution**: Make sure workflow is active and has a `webhookId`. Save the workflow in n8n UI to generate the webhookId.

### Issue: CORS errors when calling n8n directly
**Solution**: Use Next.js API route proxies instead of calling n8n webhooks directly from the frontend

## Production URLs

- Job Desc: `https://supercoincident-unvanquishing-bula.ngrok-free.dev/webhook/process-jd`
- Resume: `https://supercoincident-unvanquishing-bula.ngrok-free.dev/webhook/process-resume`
- Cover Letter: `https://supercoincident-unvanquishing-bula.ngrok-free.dev/webhook/process-cover-letter`
- Eval: `https://supercoincident-unvanquishing-bula.ngrok-free.dev/webhook/evaluate-ats`

